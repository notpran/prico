# Convex + MongoDB Setup Guide

This guide will help you complete the Convex setup to connect to MongoDB and eliminate TypeScript errors.

## Prerequisites

You have completed:
- ✅ MongoDB schema design with ownership fields
- ✅ Clerk authentication integration  
- ✅ User management system with ownership validation
- ✅ Community and project management functions
- ✅ Enhanced mock API for development

## Next Steps to Complete Setup

### 1. Install Convex CLI and Dependencies

```bash
npm install -g convex
npm install convex @clerk/clerk-js
```

### 2. Configure Convex Project

```bash
# Initialize Convex in your project
npx convex dev

# This will:
# - Create a Convex deployment
# - Generate environment variables
# - Set up the database connection
```

### 3. Update Environment Variables

Add to your `.env.local`:
```
# Convex (will be generated by `npx convex dev`)
NEXT_PUBLIC_CONVEX_URL=https://your-deployment.convex.cloud
CONVEX_DEPLOY_KEY=your-deploy-key

# Clerk (already configured)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=your-clerk-key
CLERK_SECRET_KEY=your-clerk-secret
```

### 4. Deploy Convex Functions

```bash
# Deploy all functions to Convex
npx convex dev

# This will deploy:
# - convex/schema.ts (database schema)
# - convex/users.ts (user management)
# - convex/communities-enhanced.ts (community functions)
# - convex/projects.ts (project functions)
# - All other function files
```

### 5. Generate API Types

Once deployed, Convex will automatically generate:
- `convex/_generated/api.ts` (real API functions)
- `convex/_generated/dataModel.ts` (TypeScript types)
- `convex/_generated/server.ts` (server functions)

### 6. Test the Integration

```bash
# Start your development server
npm run dev

# The app will now use:
# - Real Convex functions instead of mocks
# - MongoDB through Convex
# - Proper TypeScript types
# - Clerk authentication
```

## What This Setup Provides

### Database Features
- **MongoDB Integration**: Real MongoDB database through Convex
- **Schema Validation**: Proper schema with ownership fields
- **Indexes**: Optimized queries with proper indexing
- **Relationships**: User → Communities → Projects with proper joins

### Authentication & Authorization
- **Clerk Integration**: Seamless user authentication
- **Ownership Validation**: Every function checks user permissions
- **Role-Based Access**: Community and project roles with hierarchy
- **Session Management**: Automatic user creation and sync

### API Functions
- **Users**: Create, update, search, manage profiles
- **Communities**: Create, join, manage channels, roles
- **Projects**: Create, collaborate, manage files, permissions
- **Messages**: Real-time chat with mentions and reactions

### Development Features
- **Type Safety**: Full TypeScript support with generated types
- **Real-time Updates**: Automatic UI updates when data changes
- **Error Handling**: Proper error messages and validation
- **Mock Fallback**: Graceful fallback when Convex not configured

## File Structure After Setup

```
convex/
  ├── _generated/
  │   ├── api.ts          # Real API functions (auto-generated)
  │   ├── dataModel.ts    # TypeScript types (auto-generated)  
  │   └── server.ts       # Server utilities (auto-generated)
  ├── schema.ts           # Database schema with ownership
  ├── users.ts           # User management with Clerk
  ├── communities-enhanced.ts  # Community functions
  ├── projects.ts        # Project management
  ├── messages.ts        # Chat functionality
  ├── friends.ts         # Friend system
  └── directMessages.ts  # Direct messaging
```

## Common Issues & Solutions

### TypeScript Errors
- **Cause**: Using mock API instead of real Convex functions
- **Solution**: Complete Convex setup to generate real API types

### Authentication Issues  
- **Cause**: Missing Clerk + Convex integration
- **Solution**: Ensure both CLERK and CONVEX environment variables are set

### Database Errors
- **Cause**: Functions not deployed to Convex
- **Solution**: Run `npx convex dev` to deploy all functions

### Permission Errors
- **Cause**: Ownership validation working correctly
- **Solution**: Ensure users are properly authenticated with Clerk

## Testing Checklist

After setup, test these features:
- [ ] User registration and login through Clerk
- [ ] User profile creation in Convex database
- [ ] Community creation and membership
- [ ] Project creation with file management
- [ ] Real-time chat in community channels
- [ ] Ownership and permission validation
- [ ] TypeScript compilation without errors

## Support

If you encounter issues:
1. Check Convex dashboard for deployment status
2. Verify environment variables are set correctly
3. Ensure Clerk webhook is configured for user sync
4. Check browser console for any authentication errors

This setup provides a complete MongoDB + Convex + Clerk integration with proper ownership controls and real-time functionality.